unit U_planocorte;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Data.DB,
  Vcl.Grids, Vcl.DBGrids, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys, FireDAC.Phys.MySQL,
  FireDAC.Phys.MySQLDef, FireDAC.VCLUI.Wait, FireDAC.Comp.Client,
  FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.DApt,
  Data.Bind.Controls, System.Rtti, System.Bindings.Outputs, Vcl.Bind.Editors,
  Data.Bind.EngExt, Vcl.Bind.DBEngExt, Data.Bind.Components, Vcl.Buttons,
  Vcl.Bind.Navigator, FireDAC.Comp.DataSet, Data.Bind.DBScope,
  FireDAC.Phys.MSAcc, FireDAC.Phys.MSAccDef;

type
  Tfrm_Plano = class(TForm)
    Panel1: TPanel;
    Label1: TLabel;
    Label4: TLabel;
    Label2: TLabel;
    DBGrid1: TDBGrid;
    Edit2: TEdit;
    btn_filtar: TButton;
    FDCon_precos: TFDConnection;
    Driver_precos: TFDPhysMySQLDriverLink;
    BindSourcetuonmarcenaria_precos: TBindSourceDB;
    FDTabletuonmarcenaria_precos: TFDTable;
    BindingsList1: TBindingsList;
    LinkFillControlToField1: TLinkFillControlToField;
    LinkFillControlToField2: TLinkFillControlToField;
    CB_Qr: TComboBox;
    FD_PlanoCorte: TFDConnection;
    Driver_PlanoCorte: TFDPhysMySQLDriverLink;
    BindSourcetuonmarcenaria_planocorte: TBindSourceDB;
    FDT_planocorte: TFDTable;
    Panel3: TPanel;
    Label3: TLabel;
    Label5: TLabel;
    Label9: TLabel;
    txt_qtde: TEdit;
    txt_vlr: TEdit;
    btn_novo: TButton;
    btn_salvar: TButton;
    btn_editar: TButton;
    btn_excluir: TButton;
    CB_mat: TComboBox;
    DataSource1: TDataSource;
    txt_cod_mat: TEdit;
    LinkControlToField3: TLinkControlToField;
    LinkFillControlToField4: TLinkFillControlToField;
    btn_Mat: TButton;
    FDT_planocorteid_plano: TFDAutoIncField;
    FDT_planocorteid_mat: TStringField;
    FDT_planocorteqr: TStringField;
    FDT_planocorteqtde: TStringField;
    FDT_planocortetotal: TStringField;
    FDT_planocortevalor: TStringField;
    FDT_planocortemat: TStringField;
    LinkControlToField4: TLinkControlToField;
    lbl_total: TLabel;
    Label10: TLabel;
    LinkFillControlToField3: TLinkFillControlToField;
    procedure FDT_planocorteBeforePost(DataSet: TDataSet);
    procedure btn_salvarClick(Sender: TObject);
    procedure btn_novoClick(Sender: TObject);
    procedure FDT_planocorteBeforeEdit(DataSet: TDataSet);
    procedure btn_excluirClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure txt_qtdeChange(Sender: TObject);
    procedure FormActivate(Sender: TObject);

    private
    procedure Desbloqueia;
    procedure Bloqueia;
    procedure Limpar;

  public
    { Public declarations }
  end;

var
  frm_Plano: Tfrm_Plano;

implementation

{$R *.dfm}

uses U_Clientes, U_Orcamento, U_Projetos, U_Cadastro;

procedure Tfrm_Plano.Bloqueia;
begin
 CB_mat.Enabled := False;
 CB_Qr.Enabled := False;
 txt_cod_mat.Enabled := False;
 txt_qtde.Enabled := False;
 txt_vlr.Enabled := False;
 //txt_larg.Enabled := False;
end;

procedure Tfrm_Plano.btn_excluirClick(Sender: TObject);
begin
FDT_planocorte.delete;
end;

procedure Tfrm_Plano.btn_novoClick(Sender: TObject);
begin
FDT_planocorte.Insert;
Desbloqueia;
Limpar;
end;

procedure Tfrm_Plano.btn_salvarClick(Sender: TObject);

begin
FDT_planocorte.Post;
Limpar;
txt_qtde.SetFocus;

if Application.MessageBox('Deseja adicionar mais?','',MB_ICONQUESTION+MB_YESNO) = mrYes then
begin
FDT_planocorte.Insert;
Desbloqueia;
Limpar;
end
else
begin
Bloqueia;
end;

end;

procedure Tfrm_Plano.Desbloqueia;
begin
 CB_mat.Enabled := True;
 CB_Qr.Enabled := True;
 txt_cod_mat.Enabled := True;
 txt_qtde.Enabled := True;

end;

procedure Tfrm_Plano.FDT_planocorteBeforeEdit(DataSet: TDataSet);
begin
Desbloqueia;
FDT_planocorte.Edit;

end;

procedure Tfrm_Plano.FDT_planocorteBeforePost(DataSet: TDataSet);
begin
FDT_planocorte.FieldByName('id_mat').Value := txt_cod_mat.TExt;
FDT_planocorte.FieldByName('qr').Value := CB_Qr.text;
FDT_planocorte.FieldByName('qtde').Value := txt_qtde.Text;
FDT_planocorte.FieldByName('valor').Value := txt_vlr.Text;
FDT_planocorte.FieldByName('total').Value := lbl_total.Caption;
FDT_planocorte.FieldByName('mat').Value := CB_mat.Text;


end;



procedure Tfrm_Plano.FormActivate(Sender: TObject);
begin
Cad_Orcamento.FD_Con_PCP.Connected := True;
Cad_Orcamento.FDTablepcp.Active:=True;
end;

procedure Tfrm_Plano.FormClose(Sender: TObject; var Action: TCloseAction);
begin

FDT_planocorte.Close;
FD_PlanoCorte.Close;


FDTabletuonmarcenaria_precos.Close;
FDCon_precos.Close;

frm_Plano.hide;
Principal := TPrincipal.Create(self);
Principal.ShowModal;
end;

procedure Tfrm_Plano.Limpar;
begin
 txt_qtde.text := '';
 //txt_comp.text := '';
 //txt_larg.text := '';
end;


procedure Tfrm_Plano.txt_qtdeChange(Sender: TObject);
begin
var mat, vlr, tot: double;
begin

if txt_qtde.Text = '' then
begin
  txt_qtde.Text := '';
end
else
begin
  mat := strtoFloat(txt_qtde.Text);
  vlr := StrToFloat(txt_vlr.Text);

  tot := (mat * vlr);
  lbl_total.caption := FloatToStr(tot);

end;
end;
end;

end.

